name: actions-jobs
on: 
  workflow_dispatch:
  pull_request:
    branches: [ "main", "master" ]

#**************************************************************************************************************
# define environment variables used throughout the workflow
# FALCON_CLIENT_ID and FALCON_CLIENT_SECRET are api credentials created in the crowdstrike console
#**************************************************************************************************************

env:
  FALCON_CLIENT_ID: ${{ secrets.FALCON_CLIENT_ID }} 
  FALCON_CLIENT_SECRET: ${{ secrets.FALCON_CLIENT_SECRET }}
  ECR_REPO: kkuhns
  ECR_TAG: demo

jobs:
  sec-scans:
    runs-on: ubuntu-latest

#**************************************************************************************************************
# checkout the code so we have it locally on the runner
#**************************************************************************************************************

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

#**************************************************************************************************************
# Get list of changed IaC files for PR scans
#**************************************************************************************************************

    - name: Get changed IaC files
      id: changed-files
      run: |
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          echo "This is a PR - scanning only changed files"
          
          # Get files changed in this PR
          git diff --name-only origin/${{ github.base_ref }}..HEAD > all_changed_files.txt
          
          # Filter for IaC files (adjust extensions as needed for your use case)
          grep -E '\.(tf|tfvars|yaml|yml|json|dockerfile|Dockerfile)$' all_changed_files.txt > iac_changed_files.txt || true
          
          if [ -s iac_changed_files.txt ]; then
            echo "Changed IaC files found:"
            cat iac_changed_files.txt
            
            # Create space-separated list for the scan
            CHANGED_FILES=$(cat iac_changed_files.txt | tr '\n' ' ' | sed 's/[[:space:]]*$//')
            echo "scan_path=$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "has_iac_changes=true" >> $GITHUB_OUTPUT
            echo "scan_mode=pr_changes" >> $GITHUB_OUTPUT
          else
            echo "No IaC files changed in this PR"
            echo "has_iac_changes=false" >> $GITHUB_OUTPUT
            echo "scan_mode=pr_changes" >> $GITHUB_OUTPUT
          fi
        else
          echo "Manual trigger - scanning entire repository"
          echo "scan_path=." >> $GITHUB_OUTPUT
          echo "has_iac_changes=true" >> $GITHUB_OUTPUT
          echo "scan_mode=full_repo" >> $GITHUB_OUTPUT
        fi

#**************************************************************************************************************
# create directory where scan results will be stored
#**************************************************************************************************************

    - name: Create output directory
      run: mkdir -p ./scan-results

#**************************************************************************************************************
# use the crowdstrike action to scan the current repo for iac files
# outputs results to ./scan-results with a timestamp in the filename
#**************************************************************************************************************

    - name: Run FCS IaC Scan
      uses: crowdstrike/fcs-action@v1.1.0
      id: fcs
      if: steps.changed-files.outputs.has_iac_changes == 'true'
      with:
        falcon_client_id: ${{ secrets.FALCON_CLIENT_ID }}
        falcon_region: 'us-1'
        path: ${{ steps.changed-files.outputs.scan_path }}
        report_formats: 'sarif'
        output_path: './scan-results'
        fail_on: ${{ github.event_name == 'pull_request' && 'critical=1,high=1' || '' }}
      env:
        FALCON_CLIENT_SECRET: ${{ secrets.FALCON_CLIENT_SECRET }}

    - name: No IaC changes detected
      if: steps.changed-files.outputs.has_iac_changes == 'false'
      run: |
        echo "::notice::No IaC files were changed in this PR. Skipping security scan."
        echo "Scan mode: ${{ steps.changed-files.outputs.scan_mode }}"

#**************************************************************************************************************
# transform the sarif file to match github security requirements
#**************************************************************************************************************

    - name: Transform SARIF file
      if: always() && steps.changed-files.outputs.has_iac_changes == 'true'
      run: |
        if ls ./scan-results/*-scan-results.sarif 1> /dev/null 2>&1; then
          cp ./scan-results/*-scan-results.sarif original.sarif
          jq '
            .runs[].tool.driver.informationUri = "https://www.crowdstrike.com" |
            .runs[].tool.driver.rules[] |= (
              if .defaultConfiguration.level == "critical" or .defaultConfiguration.level == "high" then .defaultConfiguration.level = "error"
              elif .defaultConfiguration.level == "medium" then .defaultConfiguration.level = "warning"
              elif .defaultConfiguration.level == "low" or .defaultConfiguration.level == "informational" then .defaultConfiguration.level = "note"
              else .defaultConfiguration.level = "warning"
              end
            )
          ' original.sarif > scan-results.sarif
        else
          echo "No SARIF file found to transform"
        fi

#**************************************************************************************************************
# upload the transformed sarif file to github security
#**************************************************************************************************************

    - name: Upload SARIF report to GitHub Code scanning
      uses: github/codeql-action/upload-sarif@v3
      if: always() && hashFiles('scan-results.sarif') != ''
      with:
        sarif_file: scan-results.sarif

#**************************************************************************************************************
# Add summary of what was scanned
#**************************************************************************************************************

    - name: Scan Summary
      if: always()
      run: |
        echo "## IaC Security Scan Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Scan Mode**: ${{ steps.changed-files.outputs.scan_mode }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Path Scanned**: \`${{ steps.changed-files.outputs.scan_path }}\`" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event_name }}" == "pull_request" ] && [ -f iac_changed_files.txt ]; then
          echo "- **Changed IaC Files**:" >> $GITHUB_STEP_SUMMARY
          while read -r file; do
            echo "  - $file" >> $GITHUB_STEP_SUMMARY
          done < iac_changed_files.txt
        fi

#**************************************************************************************************************
# COMMENTED OUT - Container scanning sections for testing IaC-only workflow
#**************************************************************************************************************

    # - name: Ensure docker is not running
    #   run: |
    #     sudo systemctl stop docker.service
    #     sudo systemctl stop docker.socket

    # - name: Podman build
    #   run: |
    #     podman build -t ${{ secrets.AWS_ACCOUNT_ID}}.dkr.ecr.us-east-2.amazonaws.com/${{ env.ECR_REPO }}:${{ env.ECR_TAG }} .
    #     systemctl --user enable --now podman.socket

    # - name: Configure AWS credentials for FCS CLI
    #   uses: aws-actions/configure-aws-credentials@v4
    #   with:
    #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_FCS }}
    #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_FCS }}
    #     aws-region: us-west-2

    # - name: Download FCS CLI
    #   run: |
    #     aws s3 cp s3://fcs-cli-beta-testing-kc/fcs /usr/local/bin/fcs
    #     chmod +x /usr/local/bin/fcs

    # - name: Configure FCS CLI
    #   env:
    #     FCS_CLIENT_ID: ${{ secrets.FALCON_CLIENT_ID }}
    #     FCS_CLIENT_SECRET: ${{ secrets.FALCON_CLIENT_SECRET }}
    #     FCS_FALCON_REGION: "us-1"
    #   run: |
    #     fcs configure --client-id "$FCS_CLIENT_ID" --client-secret "$FCS_CLIENT_SECRET" --falcon-region "$FCS_FALCON_REGION"
   
    # - name: Run FCS CLI
    #   run: |
    #     fcs scan image ${{ secrets.AWS_ACCOUNT_ID}}.dkr.ecr.us-east-2.amazonaws.com/${{ env.ECR_REPO }}:${{ env.ECR_TAG }}
